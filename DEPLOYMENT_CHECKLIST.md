# Deployment Checklist

## ‚úÖ Pre-Deployment Requirements

### 1. Database Migration
- [ ] Run the SQL migration to add `image_data` and `tag_data` columns
- [ ] Verify database functions are created successfully
- [ ] Test database queries with sample data

### 2. Environment Variables
- [ ] `OPENAI_API_KEY` - OpenAI API key for GPT image generation
- [ ] `GOOGLE_API_KEY` - Google AI API key for Imagen generation
- [ ] `SUPABASE_URL` - Your Supabase project URL
- [ ] `SUPABASE_ANON_KEY` - Your Supabase anonymous key
- [ ] `JIRA_URL` - Your Jira instance URL
- [ ] `JIRA_USERNAME` - Jira username
- [ ] `JIRA_API` - Jira API token

### 3. Dependencies
- [ ] All npm packages installed (`npm install`)
- [ ] Google AI SDK properly configured
- [ ] TypeScript compilation successful (`npx tsc --noEmit`)

### 4. Code Changes
- [ ] JiraFetchJob updated with 25 result limit ‚úÖ
- [ ] EventProcessJob updated for dual image generation ‚úÖ
- [ ] ImagenGenerator service implemented ‚úÖ
- [ ] Database types updated ‚úÖ
- [ ] Utility functions created ‚úÖ

## üöÄ Deployment Steps

### 1. Database Setup
```sql
-- Run this in your Supabase SQL editor
ALTER TABLE public.test_calendar_events 
ADD COLUMN image_data JSONB,
ADD COLUMN tag_data JSONB;

CREATE INDEX idx_events_image_data ON public.test_calendar_events USING GIN (image_data);
CREATE INDEX idx_events_tag_data ON public.test_calendar_events USING GIN (tag_data);

-- Create helper functions (see migration file for full SQL)
```

### 2. Environment Configuration
```bash
# Add to your .env file
GOOGLE_API_KEY=your_google_api_key_here
```

### 3. Test Deployment
```bash
# Test TypeScript compilation
npx tsc --noEmit

# Test individual jobs
npm run test:jobs

# Test Jira connection
npm run start:cron
```

### 4. Production Deployment
```bash
# Start the jobs using PM2
npm run start:jobs

# Or manually start each job
npx ts-node src/jobs/jiraFetchEntry.ts
npx ts-node src/jobs/eventProcessEntry.ts
```

## üîç Post-Deployment Verification

### 1. Job Monitoring
- [ ] JiraFetchJob is running and fetching data
- [ ] EventProcessJob is processing events
- [ ] No errors in job logs
- [ ] Images are being generated by both models

### 2. Data Verification
- [ ] Events are being created in database
- [ ] Image data is stored with proper structure
- [ ] Tag data is indexed correctly
- [ ] Both GPT and Imagen images are generated

### 3. Performance Monitoring
- [ ] Job execution times are reasonable
- [ ] No memory leaks
- [ ] API rate limits not exceeded
- [ ] Database performance is acceptable

## ‚ö†Ô∏è Known Issues & Considerations

### 1. API Rate Limits
- OpenAI: Monitor usage and rate limits
- Google AI: Monitor usage and rate limits
- Jira: 25 results limit implemented

### 2. Error Handling
- Jobs have retry mechanisms
- Failed events are logged
- Timeout handling for long-running operations

### 3. Resource Usage
- Dual image generation doubles processing time
- Storage usage will increase significantly
- Monitor Supabase storage quotas

## üÜò Troubleshooting

### Common Issues:
1. **Google API Key Error**: Verify GOOGLE_API_KEY is set correctly
2. **Database Connection**: Check Supabase credentials
3. **Image Generation Failures**: Check API quotas and rate limits
4. **Memory Issues**: Monitor job memory usage

### Log Locations:
- Job logs: Console output or PM2 logs
- Database logs: Supabase dashboard
- API errors: Check respective service dashboards

## üìä Expected Behavior

### JiraFetchJob:
- Runs every hour
- Fetches max 25 Jira issues
- Creates/updates events in database

### EventProcessJob:
- Runs every 5 minutes
- Processes pending events
- Generates 2 images per prompt (GPT + Imagen)
- Stores structured image and tag data

### Data Structure:
- Each event will have `image_data` array with model info
- Each event will have `tag_data` array with indexed tags
- Images are named: `{jira_id}_prompt{promptIndex}_{model}_{imageIndex}.png`
